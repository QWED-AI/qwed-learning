name: üéñÔ∏è Issue Verifiable Credential

on:
  issues:
    types: [opened, edited]

jobs:
  issue-credential:
    if: contains(github.event.issue.labels.*.name, 'certification')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install jsonld cryptography pyld requests PyJWT
      
      - name: Parse issue and verify completion
        id: parse
        run: |
          import json
          import re
          import os
          
          issue_body = os.environ['ISSUE_BODY']
          
          # Extract GitHub username
          match = re.search(r'@(\w+)', issue_body)
          # Fallback to issue creator if no @mention found
          username_from_issue = os.environ['ISSUE_CREATOR']
          username = match.group(1) if match else username_from_issue
          
          # Count checked modules
          checked = issue_body.count('[x]')
          
          print(f"::set-output name=username::{username}")
          print(f"::set-output name=modules_checked::{checked}")
          # We need 11 modules checked
          print(f"::set-output name=verified::{str(checked >= 11).lower()}")
        shell: python
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_CREATOR: ${{ github.event.issue.user.login }}
      
      - name: Generate Verifiable Credential
        if: steps.parse.outputs.verified == 'true'
        id: credential
        env:
          CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
        run: |
          python3 << 'EOF'
          import sys
          import os
          sys.path.insert(0, 'issuer')
          from qwed_certificate_issuer import QWEDCertificateIssuer
          import json
          from datetime import datetime
          
          # Load private key from secret
          private_key_content = os.environ.get('CERTIFICATE_PRIVATE_KEY')
          
          if not private_key_content:
              print("::error::CERTIFICATE_PRIVATE_KEY secret is missing!")
              sys.exit(1)
              
          # Write private key to temp file for issuer to read
          with open('private_key_temp.pem', 'w') as f:
              f.write(private_key_content)
          
          try:
              issuer = QWEDCertificateIssuer(private_key_path="private_key_temp.pem")
              credential = issuer.issue_certificate(
                  github_username="${{ steps.parse.outputs.username }}",
                  completion_date=datetime.now().strftime("%Y-%m-%d"),
                  modules_completed=11
              )
              
              # Save credential
              with open('credential.json', 'w') as f:
                  json.dump(credential, f, indent=2)
              
              # Extract credential ID for comment
              cred_id = credential.get('id', 'unknown')
              print(f"::set-output name=credential_id::{cred_id}")
              
          finally:
              # Cleanup sensitive file
              if os.path.exists('private_key_temp.pem'):
                  os.remove('private_key_temp.pem')
          
          EOF
      
      - name: Generate Badge Markdown
        if: steps.parse.outputs.verified == 'true'
        id: badge
        run: |
          echo "::set-output name=badge_md::[![Certified: AI Verification Mastery](https://img.shields.io/badge/Certified-AI_Verification_Mastery-00C853?style=flat&logo=verified&logoColor=white)](https://github.com/QWED-AI/qwed-learning/blob/main/CERTIFIED.md?recipient=${{ steps.parse.outputs.username }})"
      
      - name: Comment with Credential
        if: steps.parse.outputs.verified == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const credential = JSON.parse(fs.readFileSync('credential.json', 'utf-8'));
            
            const comment = `
            üéñÔ∏è **Congratulations, @${{ steps.parse.outputs.username }}!**
            
            You've successfully completed all 11 modules of **Master AI Verification: Stop LLM Hallucinations in Production**.
            
            ## Your Verifiable Credential
            
            Your W3C Verifiable Credential has been issued.
            
            **Credential ID:** \`${{ steps.credential.outputs.credential_id }}\`  
            **Issued:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')  
            **Valid Until:** 5 years from issue date
            
            ### Add to Your GitHub Profile
            
            Add this badge to your README:
            
            \`\`\`markdown
            ${{ steps.badge.outputs.badge_md }}
            \`\`\`
            
            ### View Your Full Credential
            
            <details>
            <summary>üìú View JSON Credential</summary>
            
            \`\`\`json
            ${JSON.stringify(credential, null, 2)}
            \`\`\`
            
            </details>
            
            ### Share Your Achievement
            
            - üìå [Add to your LinkedIn](https://www.linkedin.com/profile/edit)
            - üê¶ [Share on Twitter](https://twitter.com/intent/tweet?text=I%20completed%20the%20QWED%20AI%20Verification%20course%20%F0%9F%8E%93&url=https://github.com/QWED-AI/qwed-learning)
            
            **Welcome to the QWED Verified community!** üöÄ
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Add to certified list
        if: steps.parse.outputs.verified == 'true'
        run: |
          echo "- [@${{ steps.parse.outputs.username }}](https://github.com/${{ steps.parse.outputs.username }}) - Certified $(date +'%b %d, %Y')" >> CERTIFIED.md
      
      - name: Commit certified user
        if: steps.parse.outputs.verified == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "QWED Certificate Bot"
          git add CERTIFIED.md
          git commit -m "üéñÔ∏è Certify @${{ steps.parse.outputs.username }} - AI Verification Mastery"
          git push
